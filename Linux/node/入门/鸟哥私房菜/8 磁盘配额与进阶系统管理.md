# 磁盘配额(Quota)与进阶文档系统管理  
## Quota  
> 由于Linux是多人多工系统，因此需要限制一般使用者能使用的容量，以便可以妥善的分配资源  
  
### Quota的一般用途：
* 限制一个群组能使用的最大磁盘容量  
* 限制一个账号能使用的最大磁盘容量  
* 限制一个目录能使用的最大磁盘容量（在ext文件系统上，磁盘配额主要针对整个文件系统来处理，也就是主要针对挂载点来设计；在xfs文件系统上，我们可以针对个别目录来进行磁盘配额）  
* 限制一直账号能使用的网页空间，邮件空间以及网络硬盘空间  
### Quota的使用限制  
* 在EXT文档系统中只能针对整个filesystem  
* 需要核心支撑quota  
* 只对一般使用者有效（你也不可能对root用户限额，因为整个磁盘都是他的）  
* 不同文件系统上的quota处理情况不同，所以在使用quota之前，必须先确认文件系统（需要确定文件系统支持quota，比如vfat文件系统就不支持Linux Quota）  
### Quota针对XFS filesystem的显示项目  
* 分别针对使用者、群组和个别目录  
* 限制inode用量（可以管理使用者可以建立的档案数量）和限制block用量（管理使用者磁盘容量的限制）  
* 柔性劝导与硬性规定(soft/hard)：使用者在低于soft限值时，可以正常使用磁盘，当超过hard值时，系统会锁住该用户的磁盘使用权，当超过soft而低于hard限值，在使用者登录系统时，会出现警告，并且给予一个宽限时间(grace time)，在这个时间内，使用者将使用容量降低到soft限值之下，宽限时间就停止  
* 会倒数计时的宽限时间(grace time)：当使用者的磁盘使用量超过soft而小于hard时，会有一个倒数的时间，当我们在这段时间内将磁盘使用量处理后降低到soft限制之下，倒计时会停止；如果使用者的磁盘使用量超过了hard限制，则其使用权将会被锁住  
## 磁盘阵列(RAID)  
> RAID:Redundant Arrays of Independent Disks,立容e式磁碟列，可以透过一种技术（软件或硬件），将多个较小的磁盘整合成一个较大的磁盘，而这个较大的磁盘的功能不仅仅是存储而已，还具有资料的保护功能  
  
RAID有几个不同的等级，不同的等级的不同，整合后的磁盘具有不同的功能，具体如下：  
### RAID-0(等量模式，stripe)：效能最佳  
* 若使用相同型号、相同容量的磁盘组成时，效果更佳  
* 这种模式的RAID将磁盘先切分成等量的区块（名为chunk，一般设置为4k-1M），然后当一个文件需要写入RAID时，该文件会依据chunk的大小被切割好，再依次存放到各个磁盘中去  
* 因为文件在存放时会依据chunk大小被切割再依次存放，每个磁盘负责的资料量就降低了，所以越多磁盘组成的RAID-0的效能越好，因为每个磁盘负责的资料量更低了，而且磁盘的总容量也变大了  
* 这个模式需要承担资料损坏的风险，因为资料会存储到每个磁盘中，若其中一个磁盘损坏，这个资料就损坏了而无法读取了  
* 若使用不同容量的磁盘组成RAID-0时，当较小容量的磁盘空间被使用完后，RAID的效能就会变差  
### RAID-1(映射模式，mirror)：完整备份  
* 这种模式是让一份资料，完整的保存到两个磁盘上面  
* 这种模式也最好采用相同容量的磁盘，否则磁盘的总容量与最小那个磁盘容量相同  
* 当我们使用相同容量的磁盘组成RAID-1，磁盘总容量相当于减少了一半  
* 这种模式下，任何一颗磁盘损坏，资料还是可以完整的保存下来  
### RAID1+0，RAID0+1  
* RAID-0效能好但是资料不安全，RAID-1资料安全但效能不佳，因此我们可以将两者整合起来实现另一种模式：RAID0+1或RAID1+0  
### RAID 5：效能与资料备份的均衡考量  
* RAID 5磁盘阵列至少需要三颗以上的磁盘组成  
* 这种磁盘阵列的资料存储方式和RAID-0类似（也是将磁盘分成等量的区块，资料在存储的时候也被分成相应大小的区块，然后依次存储到各个磁盘的区块中），但在每个循环写入过程中，都会有一个同位检查资料(Parity)，用来记录其他磁盘的备份资料以进行必要时的救援  
* 每次循环写入时，都会有部分同位检查码(Parity)被记录下来，并且记录的同位检查码每次会记录在不同的磁盘中，任何一个磁盘损坏时，都由其他磁盘的检查码来重建原本磁盘内的资料  
* RAID 5因为每次循环写入时都会使用一颗磁盘来记录同位检查码，所以磁盘的总容量会是整体磁盘数量减少一颗的大小（磁盘同容量的情况下）  
* 当磁盘的损坏数量大于等于2颗时，整个RAID的资料也就损坏了，因为其只能救援一颗磁盘损坏的情况  
* 由RAID 5发展来的RAID 6在每次循环写入的过程中，使用两颗磁盘来记录Parity，因此RAID 6在两颗磁盘损坏的情况下，资料还是可以救援回来  
### Spare Disk:预备磁盘  
* 当磁盘阵列上的磁盘损坏时，我们将损坏的磁盘拔出，然后使用一个新的磁盘替换，并启动磁盘阵列，磁盘阵列会主动重建(rebuild)原来损坏的磁盘上的资料到新的磁盘上，资料就复原了，这是磁盘阵列的优点  
* 为了让系统可以即时的在磁盘损坏时主动重建，我们需要使用预备磁盘(spare disk),预备磁盘是指原本不在磁盘阵列等级中的一颗或多颗磁盘，平时不会被磁盘阵列使用，只有当磁盘阵列中的磁盘有损坏时，这可spare disk被主动的拉进磁盘阵列，并将损坏的磁盘移出磁盘阵列，然后立即重建资料  
### 磁盘阵列的优点  
* 资料的安全与可靠性：这里指的是在磁盘损坏时，资料还可以安全的救援和使用  
* 读写效能：比如RAID-0可以加强读写效能  
* 容量：可以使多颗磁盘组合起来，所以单一文件系统可以使用比较大的磁盘容量  
### 磁盘阵列的分类  
* 硬件磁盘阵列(hardware RAID)：使用磁盘阵列卡来达成阵列的目的，磁盘阵列卡上有专门的晶片来处理RAID任务，效能会较好  
* 软件磁盘阵列(software RAID)：因为磁盘阵列的优秀功能，但硬件磁盘阵列卡通常又很昂贵，我们可以使用软件来模拟磁盘阵列的功能，因此有了软件磁盘阵列  
### 软件磁盘阵列(software RAID)  
> 软件磁盘阵列不需要我们有多颗磁盘（比如CentOS上的mdadm以partition或disk为磁盘的单位），因此我们有两个以上的分区，我们就可以设计自己的磁盘阵列了  
  
软件磁盘阵列的设定：使用mdadm指令（CentOS上），该指令支持RAID-0，RAID-1，RAID10，RAID5，RAID6和spare disk，还支持类似热插拔的功能  
